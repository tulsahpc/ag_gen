#include <stdio.h>
#include <stdlib.h>
#include <string.h>

#include "ag_redisexploit.h"
#include "ag_exploit.h"
#include "redis_util.h"
#include "util.h"

int RedisExploitAdd(const char *key, struct AGExploit *exploit)
{
	char *str;

	if(exploit == NULL) {
		printf("Exploit cannot be null.");
		return 1;
	}

	str = malloc(sizeof(char)*MAXSTRLEN);
	snprintf(str, MAXSTRLEN, "%d:%s", exploit->id, exploit->name);

	RedisEnqueueValue(key, str);
	free(str);

	return 0;
}

struct AGExploit *RedisExploitGet(const char *key)
{
	char *str;
	char *saveptr;
	struct AGExploit *exploit = {0};

	if(key == NULL)
		return NULL;

	str = RedisDequeueValue(key);
	if(str != NULL){
		DEBUG_PRINT("DEQUEUE Reply string is: %s\n", str);

		char *exploit_id = strtok_r(str, DELIMITER, &saveptr);
		char *exploit_name = strtok_r(NULL, DELIMITER, &saveptr);

		exploit = malloc(sizeof(struct AGExploit));
		exploit->id = atoi(exploit_id);

		char *exploit_name_cpy = malloc(sizeof(char)*MAXSTRLEN);
		sstrcpy(exploit_name_cpy, exploit_name, MAXSTRLEN);

		exploit->name = exploit_name_cpy;

		free(str);
	}

	return exploit;
}
