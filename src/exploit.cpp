#include <algorithm>
#include <vector>
#include <libpq-fe.h>
#include <cstdlib>

#include "exploit.hpp"
#include "util_db.hpp"

using namespace std;

void Exploit::fetch_preconds()
{
 	PGresult *res;
 	int num_rows;

 	dbtrans_begin();

 	int id = this->id;

 	string sql = "SELECT * FROM exploit_precondition WHERE exploit_id = " + to_string(id);
 	res = PQexec(conn, sql.c_str());

 	dbtrans_end();

 	if(PQresultStatus(res) != PGRES_TUPLES_OK) {
		fprintf(stderr, "SELECT command failed: %s",
			PQerrorMessage(conn));
		exit(1);
	}

	num_rows = PQntuples(res);
	for(int i=0; i<num_rows; i++) {
        int type = stoi(PQgetvalue(res, i, 2));

        if(type == 0) {
            int param1 = stoi(PQgetvalue(res, i, 3));
            string property = PQgetvalue(res, i, 5);
            string value = PQgetvalue(res, i, 6);

            ParameterizedQuality qual(param1, property, value);
            preconds_q.push_back(qual);
        } else {
            int param1 = stoi(PQgetvalue(res, i, 3));
            int param2 = stoi(PQgetvalue(res, i, 4));
            string options = PQgetvalue(res, i, 7);

            ParameterizedTopology topo(param1, param2, options);
            preconds_t.push_back(topo);
        }
	}

	PQclear(res);
}

void Exploit::print_preconds_q() {
	for_each(preconds_q.begin(), preconds_q.end(), [](ParameterizedQuality& q) {
		q.print();
	});
}

void Exploit::print_preconds_t() {
    for_each(preconds_t.begin(), preconds_t.end(), [](ParameterizedTopology& t) {
        t.print();
    });
}

Exploit::Exploit(int preId, string preName, int preNumParams) : id(preId), name(preName), num_params(preNumParams) {
	fetch_preconds();
};

int Exploit::get_id(void) {
	return id;
}

string Exploit::get_name(void) {
	return name;
}

int Exploit::get_num_params(void) {
	return num_params;
}

void Exploit::print_all(void) {
	vector<Exploit> exploit_list = Exploit::fetch_all();
	for_each(exploit_list.begin(), exploit_list.end(), [](Exploit& e) {
        cout << "Exploit: " + e.get_name() << endl << "~~~~~~~~~~~~~~~~~~~~~~~~~~" << endl;
        e.print_preconds_q();
        e.print_preconds_t();
    });
}

vector<ParameterizedQuality> Exploit::precond_list_q() {
	return preconds_q;
}

vector<ParameterizedTopology> Exploit::precond_list_t() {
	return preconds_t;
}

vector<Exploit> Exploit::fetch_all(void)
{
	vector<Exploit> exploits;

	PGresult *res;
	int num_rows;

	dbtrans_begin();

	string sql = "SELECT * FROM exploit;";
	res = PQexec(conn, sql.c_str());

	dbtrans_end();

	if(PQresultStatus(res) != PGRES_TUPLES_OK) {
		fprintf(stderr, "SELECT command failed: %s",
			PQerrorMessage(conn));
	}

	num_rows = PQntuples(res);
	for (int i=0; i<num_rows; i++) {
		int id = stoi(PQgetvalue(res, i, 0));
		string name = PQgetvalue(res, i, 1);
		int num_params = stoi(PQgetvalue(res, i, 2));

		Exploit exploit(id, name, num_params);
		exploits.push_back(exploit);
	}

	PQclear(res);

	return exploits;
}
