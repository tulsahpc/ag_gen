/** \file ag_exploit.c
 * \author Kyle Cook <kylecook80@gmail.com>
 * \date June 2016
 * \copyright Copyright (C) The University of Tulsa - All Rights Reserved. Unauthorized copying or distribution of this file is strictly prohibited.
 */

#include <stdio.h>
#include <stdlib.h>
#include <libpq-fe.h>

#include "ag_exploit.h"
#include "ag_network.h"
#include "util.h"
#include "db_util.h"

struct AGExploitList *AGGetExploits()
{
	PGresult *res;
	int numRows;
	struct AGExploit **exploits;
	struct AGExploitList *exploitList;

	AGDbBeginTransaction();

	char sql[MAXSTRLEN+1] = {0};
	int wr = snprintf(sql, MAXSTRLEN, "SELECT * FROM exploit;");
	if(wr < MAXSTRLEN) {
		sql[wr] = '\0';
	} else {
		sql[MAXSTRLEN] = '\0';
	}

	res = PQexec(conn, sql);
	if (PQresultStatus(res) != PGRES_TUPLES_OK) {
		fprintf(stderr, "SELECT command failed: %s",
			PQerrorMessage(conn));
		PQclear(res);
		exit_nicely();
	}

	numRows = PQntuples(res);
	exploits = malloc(sizeof(struct AGAsset*) * numRows);

	for (int i=0; i<numRows; i++) {
		int id = atoi(PQgetvalue(res, i, 0));
		char *name = dynstr(PQgetvalue(res, i, 1));
		int num_assets = atoi(PQgetvalue(res, i, 2));

		exploits[i] = calloc(1, sizeof(struct AGAsset));
		exploits[i]->id = id;
		exploits[i]->name = name;
		exploits[i]->num_exploits = num_assets;
	}

	AGDbEndTransaction();
	PQclear(res);

	exploitList = malloc(sizeof(struct AGExploitList));
	exploitList->exploits = exploits;
	exploitList->len = numRows;

	return exploitList;
}

void AGExploitPrint(struct AGExploit *exploit)
{
	printf("exploit #%d: %s\n", exploit->id, exploit->name);
}

void AGExploitListPrint(struct AGExploitList *agl)
{
	for(int i=0; i<agl->len; i++) {
		AGExploitPrint(agl->exploits[i]);
	}
}

void AGExploitFree(struct AGExploit *exploit)
{
	if(exploit->name != NULL)
		free(exploit->name);

	free(exploit);
}

void AGExploitListFree(struct AGExploitList *list)
{
	int len = list->len;
	for(int i=0; i<len; i++) {
		struct AGExploit *exploit = list->exploits[i];
		if(exploit != NULL)
			AGExploitFree(exploit);
	}

	free(list);
}
