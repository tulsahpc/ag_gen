/** \file ag_exploit.c
 * \author Kyle Cook <kylecook80@gmail.com>
 * \date June 2016
 * \copyright Copyright (C) The University of Tulsa - All Rights Reserved. Unauthorized copying or distribution of this file is strictly prohibited.
 */

#include <stdio.h>
#include <stdlib.h>
#include <libpq-fe.h>

#include "exploit.h"
#include "network.h"
#include "util_common.h"
#include "util_list.h"
#include "util_db.h"

struct List *exploits_fetch(void)
{
	PGresult *res;
	int numRows;
	struct List *exploit_list = list_new();

	dbtrans_begin();

	char sql[MAXSTRLEN+1] = {0};
	// int wr =
	snprintf(sql, MAXSTRLEN, "SELECT * FROM exploit;");
	// if(wr < MAXSTRLEN) {
	// 	sql[wr] = '\0';
	// } else {
	// 	sql[MAXSTRLEN] = '\0';
	// }

	res = PQexec(conn, sql);
	if (PQresultStatus(res) != PGRES_TUPLES_OK) {
		fprintf(stderr, "SELECT command failed: %s",
			PQerrorMessage(conn));
		PQclear(res);
		exit_nicely();
	}

	numRows = PQntuples(res);
	for (int i=0; i<numRows; i++) {
		int id = atoi(PQgetvalue(res, i, 0));
		char *name = dynstr(PQgetvalue(res, i, 1));
		int numParams = atoi(PQgetvalue(res, i, 2));

		struct Exploit *exploit = calloc(1, sizeof(struct Exploit));
		exploit->id = id;
		exploit->name = name;
		exploit->numParams = numParams;

		list_push(exploit_list, exploit);
	}

	dbtrans_end();
	PQclear(res);

	return exploit_list;
}

void exploit_print(struct Exploit *exploit)
{
	printf("exploit #%d: %s\n", exploit->id, exploit->name);
}

void exploit_free(struct Exploit *exploit)
{
	if(exploit->name != NULL)
		free(exploit->name);

	free(exploit);
}
